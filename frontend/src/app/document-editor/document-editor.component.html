<nb-card class="h-100" *ngIf="!(formIsLoaded || error)" [nbSpinner]="true" nbSpinnerStatus="primary">
    <nb-card-body></nb-card-body>
</nb-card>
<form *ngIf="formIsLoaded" [formGroup]="form">
    <div class="flex-container">
        <div class="d-flex justify-content-between">
            <div class="mb-3 h3 document-name-input" nbTooltip="Cambiar nombre del documento" [nbTooltipDisabled]="nameOnFocus" contenteditable="true" 
                (input)="nameOnInput($any($event.target).innerText)" (blur)="nameOnBlur()" (focus)="nameOnFocus = true" [textContent]="form.get('name')?.value">
            </div>
            <div *ngIf="documentTypeId" class="d-flex align-items-center text-align-center">
                <ng-container *ngIf="!submitting">
                    <div *ngIf="actionResult" class="action-result fade-out">
                        {{actionResult}}   
                    </div>
                    <div class="mr-2" nbTooltip="Crear copia a partir del documento actual">
                        <button class="ghost-btn" nbButton ghost (click)="cloneDocument()">
                            <nb-icon icon="copy-outline" status="primary"></nb-icon>
                        </button>
                    </div>
                    <div class="mr-2" nbTooltip="Guardar cambios">
                        <button class="ghost-btn" nbButton ghost (click)="submit()">
                            <nb-icon icon="save-outline" status="primary"></nb-icon>
                        </button>
                    </div>
                    <div nbTooltip="Exportar como PDF"> 
                        <button *ngIf='documentTypeId==1' [disabled]="!documentId" class="ghost-btn" nbButton ghost [nbContextMenu]="exportOptions">
                            <nb-icon icon="download-outline" status="primary"></nb-icon>
                        </button>
                        <button *ngIf='[2, 3, 4, 5, 6].includes(documentTypeId)' [disabled]="!documentId" class="ghost-btn" nbButton ghost (click)="export()">
                            <nb-icon icon="download-outline" status="primary"></nb-icon>
                        </button>
                    </div>
                </ng-container>
                <nb-card *ngIf="submitting" class="ghost-card" [nbSpinner]="true" nbSpinnerSize="small" nbSpinnerStatus="primary">
                    <nb-card-body></nb-card-body>
                </nb-card>
            </div>
        </div>
        <div class="scrollable">
            <nb-card>
                <nb-card-header>Tipo de documento</nb-card-header>
                    <nb-card-body>
                        <div class="form-group">
                            <nb-select fullWidth placeholder="Seleccionar tipo de documento" [selected]="documentTypeId" (selectedChange)="documentTypeOnChange($event)">
                                <nb-option *ngFor="let item of documentTypes" [value]="item.id">{{item.description}}</nb-option>
                            </nb-select>
                        </div>
                        <ng-container *ngIf="documentTypeId == 1">
                            <div class="form-group">
                                <nb-checkbox (change)="adReferendumOnChange()" [checked]="form.get('adReferendum')?.value">Ad-referendum</nb-checkbox>
                            </div>
                        </ng-container>
                    </nb-card-body>
            </nb-card>
            <nb-card *ngIf="documentTypeId">
                <nb-card-header>Encabezado</nb-card-header>
                    <nb-card-body>
                       
                        <div class="form-group">
                            <label class="label col-form-label">Dependencia emisora</label>
                            <nb-select fullWidth placeholder="Seleccionar dependencia" formControlName="issuerId" [selected]="form.get('issuerId')?.value">
                                <nb-option *ngFor="let item of issuers" [value]="item.id">{{item.description}}</nb-option>
                            </nb-select>
                        </div>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="label col-form-label">Número</label>
                                    <input type="number" nbInput fullWidth formControlName="number" placeholder="Ingresar número" (input)="setDocumentName()">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="label col-form-label">Fecha de emisión</label>
                                    <input nbInput fullWidth [nbDatepicker]="datepicker" placeholder="Ingresar fecha en formato dd/mm/aa" formControlName="issueDate" (keydown)="$event.preventDefault()">
                                    <nb-datepicker #datepicker format="dd/MM/yyyy"></nb-datepicker>
                                </div>
                            </div>
                        </div>
                        <ng-container *ngIf="[4, 5, 6].includes(documentTypeId)">
                            <div class="form-group">
                                <label class="label col-form-label">Asunto</label>
                                <input  nbInput fullWidth placeholder="Ingresar asunto" formControlName="subject">           
                            </div>
                            <div class="form-group"> 
                                <textarea nbInput fullWidth placeholder="Ingresar destinatario" formControlName="destinatary"></textarea>  
                            </div>      
                        </ng-container>
                </nb-card-body>
            </nb-card>
        
            <ng-container formGroupName="body">
                <ng-container *ngIf="[1, 2, 3].includes(documentTypeId)">
                    <nb-card>
                        <nb-card-header>
                            Visto
                        </nb-card-header>
                        <nb-card-body>
                            <app-text-editor formControlName="visto" [placeholder]="hints['Visto']"></app-text-editor>
                        </nb-card-body>
                    </nb-card>
                    <ng-container *ngTemplateOutlet="sectionWithMultipleItems; context: {sectionTitle: 'Considerando', formArrayName: 'considerando', itemName:'párrafo'}"></ng-container>
                    <ng-container *ngIf="documentTypeId == 1">
                        <ng-container  *ngTemplateOutlet="sectionWithMultipleItems; context: {sectionTitle: 'Resuelve' , formArrayName: 'articulos', itemName:'artículo'}"></ng-container>
                        <nb-card>
                            <nb-card-header>
                                Anexos
                            </nb-card-header>
                            <nb-card-body>
                                <div class="form-group">
                                    <nb-checkbox (change)="hasAnexoUnicoOnChange()">Tiene anexo único?</nb-checkbox>
                                </div>
                                <app-anexo *ngFor="let item of anexosData; let i=index" [index]="i" [form]="item.form" [file]="item.fileData" (onDelete)="removeAnexo(dialog, i, 'anexo')"></app-anexo>
                                <div class="d-flex justify-content-end">
                                    <button *ngIf="(!hasAnexoUnico && anexosData.length < 10) || (hasAnexoUnico && anexosData.length < 1)" nbButton ghost class="ghost-btn" nbTooltip="Agregar anexo" (click)="addAnexo()">
                                        <nb-icon icon="plus-outline" status="success"></nb-icon>
                                    </button>
                                </div>
                            </nb-card-body>
                        </nb-card>
                    </ng-container>
                    <ng-container *ngIf="documentTypeId == 2">
                        <ng-container *ngTemplateOutlet="sectionWithMultipleItems; context: {sectionTitle: 'Declara' , formArrayName: 'articulos', itemName:'artículo'}"></ng-container>
                    </ng-container>
                    <ng-container *ngIf="documentTypeId == 3">
                        <ng-container *ngTemplateOutlet="sectionWithMultipleItems; context: {sectionTitle: 'Dispone' , formArrayName: 'articulos', itemName:'artículo'}"></ng-container>
                    </ng-container>
                </ng-container>
                <ng-container *ngIf="[4, 5, 6].includes(documentTypeId)" >
                    <nb-card>
                        <nb-card-header>Cuerpo</nb-card-header>
                        <nb-card-body>
                            <app-text-editor formControlName="cuerpo"></app-text-editor>
                        </nb-card-body>
                    </nb-card>
                </ng-container> 
            
                <ng-template #sectionWithMultipleItems let-formArrayName="formArrayName" let-sectionTitle="sectionTitle" let-itemName="itemName">
                    <ng-container [formArrayName]="formArrayName">
                        <nb-card>
                            <nb-card-header>
                                {{sectionTitle}}
                            </nb-card-header>
                            <nb-card-body>
                                <ng-container *ngFor="let item of getBodyFormArray(formArrayName).controls; let i=index">
                                    <label class="label col-form-label">{{itemName | titlecase}} {{i + 1}}</label>
                                    <div class="d-flex justify-content-between">
                                        <app-text-editor class="full-width pr-2" [formControlName]="i" [placeholder]="hints[sectionTitle]"></app-text-editor>   
                                        <button *ngIf="getBodyFormArray(formArrayName).controls.length > 1" nbButton ghost nbTooltip="Eliminar {{itemName}}" class="ghost-btn" (click)="removeItemFromBodyFormArray(dialog, i, formArrayName, itemName)">
                                            <nb-icon icon="close-outline" status="danger"></nb-icon>
                                        </button>
                                    </div>
                                </ng-container>
                                <div class="d-flex flex-row-reverse">
                                    <button nbButton ghost class="ghost-btn" nbTooltip="Agregar {{itemName}}" (click)="addItemToBodyFormArray('', formArrayName)">
                                        <nb-icon icon="plus-outline" status="success"></nb-icon>
                                    </button>
                                </div>
                            </nb-card-body>
                        </nb-card>
                    </ng-container>
                </ng-template>
            </ng-container>
        </div>
    </div>
</form>

<ng-template #dialog let-data let-ref="dialogRef">
    <nb-card>
        <nb-card-header>Eliminar {{data.item}} {{data.index+1}}?</nb-card-header>
        <nb-card-footer>
            <button nbButton status="danger" (click)="ref.close(true)" class="mr-4">Eliminar</button>
            <button nbButton (click)="ref.close(false)">Cancelar</button>
        </nb-card-footer>
    </nb-card>
</ng-template>

